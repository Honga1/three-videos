(this["webpackJsonpthree-videos"]=this["webpackJsonpthree-videos"]||[]).push([[0],[,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var r=n(0),c=n(1),a=n.n(c),i=n(7),o=n.n(i),s=(n(15),n(16),n(2)),u=n.n(s),d=n(5),l=n(4),f=function(e){var t=e.start,n=e.middle,a=e.end,i=Object(c.useRef)(null),o=Object(c.useState)(),s=Object(l.a)(o,2),f=s[0],j=s[1],p={width:t.videoWidth,height:t.videoHeight},O=Object(c.useState)(0),x=Object(l.a)(O,2),m=x[0],h=x[1];return Object(c.useEffect)((function(){j([t,function(){var e=Object(d.a)(u.a.mark((function e(){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n;case 2:return t=e.sent,e.abrupt("return",b(t));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()(),a])}),[a,n,t]),v(60,Object(d.a)(u.a.mark((function e(){var t,n,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==f){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,f[m];case 4:if(n=e.sent,r=null===(t=i.current)||void 0===t?void 0:t.getContext("2d"),void 0!==n){e.next=8;break}return e.abrupt("return");case 8:if(void 0!==r&&null!==r){e.next=10;break}return e.abrupt("return");case 10:r.drawImage(n,0,0,p.width,p.height);case 11:case"end":return e.stop()}}),e)})))),Object(c.useEffect)((function(){if(void 0!==f){var e=function(){var e=Object(d.a)(u.a.mark((function e(){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f[m];case 2:if(void 0!==(t=e.sent)){e.next=5;break}throw new Error("currentVideoIndex out of range. Got ".concat(m,", expected between 0 and ").concat(f.length));case 5:return t.onended=function(){return h((m+1)%f.length)},(n=t).currentTime>0&&!n.paused&&!n.ended&&n.readyState>2||(console.log("playing video ".concat(m)),t.play()),e.abrupt("return",(function(){t.pause()}));case 8:case"end":return e.stop()}var n}),e)})));return function(){return e.apply(this,arguments)}}()();return function(){e.then((function(e){return null===e||void 0===e?void 0:e()}))}}}),[m,f]),Object(r.jsx)("canvas",{style:{width:"100%"},ref:i,width:p.width,height:p.height})};function b(e){return j.apply(this,arguments)}function j(){return(j=Object(d.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var r=document.createElement("video");r.src=URL.createObjectURL(t),r.load(),r.onloadeddata=function(){return e(r)},r.onerror=function(e){return n(e)}})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var v=function(e,t){var n=Object(c.useRef)(),r=Object(c.useRef)(),a=Object(c.useCallback)((function(e){if(void 0!==r.current){var n=e-r.current;t(n)}r.current=e}),[t]);Object(c.useEffect)((function(){var t=setInterval((function(){n.current=requestAnimationFrame(a)}),1e3/e);return function(){n.current&&cancelAnimationFrame(n.current),t&&clearInterval(t)}}),[a,e])},p=n(3),O=(n(18),Object(c.forwardRef)((function(e,t){return Object(r.jsx)("button",Object(p.a)(Object(p.a)({ref:t,className:"Button"},e),{},{children:e.children}))}))),x=(n(19),function(e){var t=e.reason;return Object(r.jsx)("div",{className:"Message ErrorMessage",children:Object(r.jsxs)("span",{children:["Error: ",t]})})}),m=function(e){var t=e.text;return Object(r.jsx)("div",{className:"Message PromptMessage",children:Object(r.jsx)("span",{children:t})})},h=function(e){var t=e.text;return Object(r.jsx)("div",{className:"Message SuccessMessage",children:Object(r.jsxs)("span",{children:["Success: ",t]})})},g=function(e){var t=e.text;return Object(r.jsx)("div",{className:"Message NeutralMessage",children:Object(r.jsx)("span",{children:t})})},w=n(8),S=n.n(w),k=n(9),y={audioStream:void 0,videoStream:void 0,recordings:{},fakedRecording:void 0,fakedRecordingPromise:void 0,staticFiles:void 0,isPlaybackReady:!1,config:{recordingDuration:10,apiUrl:"/"===window.location.href[window.location.href.length-1]?window.location.href.slice(0,-1):window.location.href,webcamScale:2}},R=S()((function(e,t){return Object(p.a)(Object(p.a)({},y),{},{setAudioStream:function(n){t().closeStreams(),n.getTracks().forEach((function(e){e.addEventListener("ended",(function(){t().closeStreams()}))})),e({audioStream:n})},setVideoStream:function(n){t().closeStreams(),n.getTracks().forEach((function(e){e.addEventListener("ended",(function(){t().closeStreams()}))})),e({videoStream:n})},closeStreams:function(){var n=t().audioStream,r=t().videoStream;n&&n.getTracks().forEach((function(e){e.stop()})),r&&r.getTracks().forEach((function(e){e.stop()})),e({audioStream:void 0,videoStream:void 0})},setVideoRecording:function(t){e({recordings:{video:t}})},setStaticFiles:function(t){var n=t.start,r=t.middle,c=t.end;e({staticFiles:{start:n,middle:r,end:c}})},setFakedRecording:function(t){e({fakedRecording:t})},setFakedRecordingPromise:function(t){e({fakedRecordingPromise:t})},setPlaybackReadiness:function(t){return e({isPlaybackReady:t})},resetState:function(){var n=Object(p.a)({},t().config);e(Object(p.a)(Object(p.a)({},y),{},{config:Object(p.a)({},n)}))}})})),F=Object(k.a)(R),P=function(e){var t=e.apiUrl,n=F((function(e){var t;return null===(t=e.staticFiles)||void 0===t?void 0:t.middle})),a=F((function(e){var t;return null===(t=e.recordings)||void 0===t?void 0:t.video})),i=F((function(e){return e.fakedRecording})),o=F((function(e){return e.config.webcamScale})),s=F((function(e){return e.setFakedRecording})),f=F((function(e){return e.setFakedRecordingPromise})),b=Object(c.useState)(void 0===n?"awaitingAudioSource":void 0===a?"awaitingDestinationVideo":i?"success":"prompt"),j=Object(l.a)(b,2),v=j[0],p=j[1];Object(c.useEffect)((function(){p(void 0===n?"awaitingAudioSource":void 0===a?"awaitingDestinationVideo":i?"success":"prompt")}),[n,a,i]);var w=function(){var e=Object(d.a)(u.a.mark((function e(){var r,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n&&a){e.next=4;break}return console.error("Not all sources are ready. source: ".concat(n,", destination: ").concat(a,")")),p("errorSources"),e.abrupt("return");case 4:(r=new FormData).append("image",a.blob),r.append("webcamScale",o.toFixed(0)),c=new Promise(function(){var e=Object(d.a)(u.a.mark((function e(n,c){var a,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,p("awaitingResult"),e.next=4,fetch(t+"/three_videos_demo",{method:"POST",body:r,mode:"cors"});case 4:return a=e.sent,e.next=7,a.blob();case 7:i=e.sent,p("success"),s(i),n(i),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(0),p("errorApi"),console.error(e.t0),c(e.t0);case 18:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t,n){return e.apply(this,arguments)}}()),f(c);case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(r.jsxs)("div",{className:"Api",children:["awaitingAudioSource"===v&&Object(r.jsx)(g,{text:"Awaiting audio source"}),"awaitingDestinationVideo"===v&&Object(r.jsx)(g,{text:"Awaiting destination video"}),"prompt"===v&&Object(r.jsx)(m,{text:"Source and Destination ready to be faked"}),!v.includes("awaiting")&&Object(r.jsx)(O,{onClick:w,children:"Send to API"}),"awaitingResult"===v&&Object(r.jsx)(g,{text:"Waiting for Api response"}),"success"===v&&Object(r.jsx)(h,{text:"Got faked recording from Api"}),"errorApi"===v&&Object(r.jsx)(x,{reason:"Could not fetch from Api"}),"errorSources"===v&&Object(r.jsx)(x,{reason:"Souces are not ready"})]})},A=function(){var e=F((function(e){return!!e.staticFiles})),t=F((function(e){return e.setStaticFiles})),n=Object(c.useState)(e?"loaded":"notLoaded"),a=Object(l.a)(n,2),i=a[0],o=a[1];return Object(c.useEffect)((function(){e||function(){var e=Object(d.a)(u.a.mark((function e(){var n,r,c,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o("loading"),e.prev=1,e.next=4,E("videos/1.mp4");case 4:return n=e.sent,e.next=7,N("videos/2.wav");case 7:return r=e.sent,e.next=10,E("videos/3.mp4");case 10:c=e.sent,o("loaded"),t({start:n,middle:r,end:c}),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(1),o("error"),console.warn("Could not load element ".concat(null===e.t0||void 0===e.t0||null===(a=e.t0.path[0])||void 0===a?void 0:a.src)),console.error(e.t0);case 20:case"end":return e.stop()}}),e,null,[[1,15]])})));return function(){return e.apply(this,arguments)}}()()}),[e,t]),Object(r.jsxs)("div",{className:"StaticFileLoader",children:["notLoaded"===i&&Object(r.jsx)(g,{text:"Files not loaded"}),"loading"===i&&Object(r.jsx)(g,{text:"Files loading"}),"loaded"===i&&Object(r.jsx)(h,{text:"Files loaded!"}),"error"===i&&Object(r.jsx)(x,{reason:"Files could not load"})]})},E=function(){var e=Object(d.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=Object(d.a)(u.a.mark((function e(n,r){var c,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(t);case 2:return e.next=4,e.sent.blob();case 4:c=e.sent,(a=document.createElement("video")).src=URL.createObjectURL(c),a.onerror=function(e){return r(e)},a.onloadeddata=function(){n(a)},a.load();case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),N=function(){var e=Object(d.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var r=document.createElement("audio");r.src=t,r.load(),r.onerror=function(e){return n(e)},r.oncanplaythrough=function(){e(r),r.oncanplaythrough=null}})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),U=(n(20),function(){var e=F((function(e){return e.staticFiles})),t=F((function(e){return e.fakedRecordingPromise})),n=F((function(e){return e.setPlaybackReadiness}));return Object(c.useEffect)((function(){n(!(!e||!t))}),[t,e,n]),e?t?Object(r.jsx)(h,{text:"Videos Ready"}):Object(r.jsx)(x,{reason:"Fake recording not received"}):Object(r.jsx)(x,{reason:"Static videos not loaded"})}),C=new AbortController,D=C.signal;function L(e){if(200===e.status)return e;throw new Error(e.statusText)}var I=function(e){var t=e.apiUrl,n=Object(c.useCallback)(Object(d.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t+"/three_videos_is_up",{method:"POST",mode:"cors",body:new FormData,signal:D}).then(L);case 3:return n=e.sent,e.next=6,n.blob();case 6:if(!(e.sent.size<=0)){e.next=9;break}throw new Error("API Failed. Did not get blob successfully");case 9:s("success"),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),s("errorApi"),console.error(e.t0);case 16:case"end":return e.stop()}}),e,null,[[0,12]])}))),[t]);Object(c.useEffect)((function(){n();var e=setInterval(Object(d.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C.abort(),C=new AbortController,D=C.signal,e.next=5,n();case 5:case"end":return e.stop()}}),e)}))),1e4);return function(){return clearInterval(e)}}),[n]);var a=Object(c.useState)("idle"),i=Object(l.a)(a,2),o=i[0],s=i[1];return Object(r.jsxs)("div",{className:"Api",children:["idle"===o&&Object(r.jsx)(g,{text:"Api test idle"}),"success"===o&&Object(r.jsx)(h,{text:"Api is Up"}),"errorApi"===o&&Object(r.jsx)(x,{reason:"Api is down"})]})},T=(n(21),function(e){return Object(r.jsx)("div",{className:"LabelledInput",children:Object(r.jsxs)("label",{className:"Label",children:[Object(r.jsxs)("span",{children:[e.label," "]}),Object(r.jsx)("input",Object(p.a)(Object(p.a)({className:"Input"},e),{},{children:e.children}))]})})}),V=(n(22),function(e){return Object(r.jsx)("div",{className:"LabelledSelect",children:Object(r.jsxs)("label",{className:"Label",children:[Object(r.jsxs)("span",{children:[e.label," "]}),Object(r.jsx)("select",Object(p.a)(Object(p.a)({className:"Select"},e),{},{children:e.options.map((function(e,t){var n=Object(l.a)(e,2),c=n[0],a=n[1];return Object(r.jsx)("option",{value:c,children:a},t)}))}))]})})}),M=function(){var e=F((function(e){return e.config.webcamScale})),t=F((function(e){return e.config.recordingDuration})),n=F((function(e){return e.config.apiUrl}));return Object(r.jsxs)("div",{className:"Config",children:[Object(r.jsx)(T,{label:"Recording Duration:",name:"recordingDuration",type:"number",min:0,max:16,value:t,onChange:function(e){var t=R.getState().config,n=parseInt(e.target.value,10);R.setState({config:Object(p.a)(Object(p.a)({},t),{},{recordingDuration:n})})}}),Object(r.jsx)(T,{label:"API Url:",name:"apiUrl",type:"string",value:n,onChange:function(e){var t=R.getState().config,n=e.target.value;R.setState({config:Object(p.a)(Object(p.a)({},t),{},{apiUrl:n})})}}),Object(r.jsx)(V,{label:"Webcam Scale",options:[[1,"100%"],[2,"50%"],[3,"33%"],[4,"25%"]],value:e,onChange:function(e){var t=R.getState().config,n=parseInt(e.target.value,10);R.setState({config:Object(p.a)(Object(p.a)({},t),{},{webcamScale:n})})}})]})},B=function(){var e=F((function(e){return e.config.apiUrl})),t=Object(c.useState)(!0),n=Object(l.a)(t,2),a=n[0],i=n[1],o=Object(c.useRef)(null),s="translate(0, 0)",u=Object(c.useState)(s),d=Object(l.a)(u,2),f=d[0],b=d[1];return Object(r.jsxs)("div",{style:{transform:f},className:"DevUi",children:[Object(r.jsx)(O,{ref:o,onClick:function(){var e;i(!a);var t=null===(e=o.current)||void 0===e?void 0:e.getBoundingClientRect().bottom;if(a&&t){var n="translate(0, ".concat(window.innerHeight-t,"px)");b(n)}else b(s)},children:a?"Hide":"Show"}),Object(r.jsx)(M,{}),Object(r.jsx)(A,{}),Object(r.jsx)(I,{apiUrl:e}),Object(r.jsx)(P,{apiUrl:e}),Object(r.jsx)(U,{}),Object(r.jsx)(O,{onClick:R.getState().resetState,children:"Reset State"})]})},_=function(){var e=F((function(e){return!!e.videoStream})),t=F((function(e){return e.setVideoStream})),n=Object(c.useState)(e?"accepted":"prompt"),a=Object(l.a)(n,2),i=a[0],o=a[1];e&&"accepted"!==i&&o("accepted"),e||"accepted"!==i||o("errorDisconnected");var s=function(){var e=Object(d.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W();case 2:if(n=e.sent){e.next=6;break}return o("errorVideo"),e.abrupt("return");case 6:t(n);case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(r.jsxs)("div",{className:"Permissions",children:[Object(r.jsx)(m,{text:"This is an interactive documentary. The interaction is provided via your microphone and webcam. Please enable this now."}),Object(r.jsx)(O,{onClick:s,children:"Enable Webcam"}),"accepted"===i&&Object(r.jsx)(m,{text:"Devices connected!"}),"errorVideo"===i&&Object(r.jsx)(x,{reason:"Could not get webcam."}),"errorDisconnected"===i&&Object(r.jsx)(x,{reason:"Devices disconnected."})]})};function W(){return H.apply(this,arguments)}function H(){return(H=Object(d.a)(u.a.mark((function e(){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia({video:{width:1280,height:720,facingMode:"user"},audio:!1});case 3:return t=e.sent,e.abrupt("return",t);case 7:return e.prev=7,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}var G=function(e){var t=e.stream,n=e.duration,a=Object(c.useState)(n),i=Object(l.a)(a,2),o=i[0],s=i[1],f=Object(c.useState)(!1),b=Object(l.a)(f,2),j=b[0],v=b[1],p=F((function(e){return e.setVideoRecording})),x=Object(c.useMemo)((function(){return J(t)}),[t]),w=Object(c.useState)("prompt"),S=Object(l.a)(w,2),k=S[0],y=S[1];Object(c.useEffect)((function(){j||"recorded"!==k&&(y("prompt"),s(n),v(!1))}),[j,k,t,n]),Object(c.useEffect)((function(){if(j){var e=setTimeout(Object(d.a)(u.a.mark((function e(){var t,n,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o>0)){e.next=3;break}return s(o-1),e.abrupt("return");case 3:return e.next=5,x.stop();case 5:t=e.sent,n=t.videoBlob,r=t.videoUrl,y("recorded"),v(!1),p({blob:n,url:r});case 11:case"end":return e.stop()}}),e)}))),1e3);return function(){return clearTimeout(e)}}}),[j,p,o,x]);return Object(r.jsxs)("div",{className:"VideoRecorder",children:["prompt"===k&&Object(r.jsx)(m,{text:"Our AI needs to be trained. Please record ".concat(n," seconds of your webcam")}),"recording"===k&&Object(r.jsx)(g,{text:"Recoding for another: ".concat(o,"s")}),"recorded"===k&&Object(r.jsx)(h,{text:"Trained!"}),"recording"!==k&&Object(r.jsx)(O,{onClick:function(){s(n),y("recording"),v(!0),x.start()},children:"Record Video"})]})},J=function(e){var t=new MediaRecorder(e,{mimeType:"video/webm; codecs=h264"}),n=[];t.addEventListener("dataavailable",(function(e){n.push(e.data)}));return{start:function(){n.length=0,t.start()},stop:function(){return new Promise((function(e){t.addEventListener("stop",(function(){var t=new Blob(n,{type:"video/webm"}),r=URL.createObjectURL(t);e({videoBlob:t,videoUrl:r})})),t.stop()}))}}},q=(n(23),function(e){var t=e.stream,n=Object(c.useRef)(null);return Object(c.useEffect)((function(){n.current&&(n.current.srcObject=t)}),[t]),Object(r.jsx)("div",{className:"VideoStreamPreview",children:Object(r.jsx)("video",{autoPlay:!0,ref:n})})}),z=(n(24),function(){var e=F((function(e){return!!e.videoStream})),t=F((function(e){return e.videoStream})),n=F((function(e){return e.isPlaybackReady})),c=F((function(e){return e.config.recordingDuration}));return Object(r.jsx)(r.Fragment,{children:!n&&Object(r.jsxs)("div",{className:"UserUi",children:[!e&&Object(r.jsx)(_,{}),void 0!==t&&Object(r.jsxs)(r.Fragment,{children:[Object(r.jsx)(G,{stream:t,duration:c}),Object(r.jsx)(q,{stream:t})]})]})})});var K=function(){var e=F((function(e){var t;return null===(t=e.staticFiles)||void 0===t?void 0:t.start})),t=F((function(e){var t;return null===(t=e.staticFiles)||void 0===t?void 0:t.end})),n=F((function(e){return e.fakedRecordingPromise}));return Object(r.jsx)("div",{className:"App",children:Object(r.jsxs)("div",{className:"AppContents",children:[Object(r.jsx)(z,{}),Object(r.jsx)(B,{}),!!e&&!!n&&!!t&&Object(r.jsx)(f,{start:e,middle:n,end:t})]})})},Q=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,26)).then((function(t){var n=t.getCLS,r=t.getFID,c=t.getFCP,a=t.getLCP,i=t.getTTFB;n(e),r(e),c(e),a(e),i(e)}))};o.a.render(Object(r.jsx)(a.a.StrictMode,{children:Object(r.jsx)(K,{})}),document.getElementById("root")),Q()}],[[25,1,2]]]);
//# sourceMappingURL=main.9851d18c.chunk.js.map